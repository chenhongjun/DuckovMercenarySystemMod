# 贿赂敌人 Mod 功能说明

## 🎯 核心功能

**用金钱收买敌人，让他们为你战斗！**

## 🎮 使用方法

### 基本操作（俯视图游戏）
1. **靠近敌人** - 走到敌人附近（默认3米范围内）
2. **按E键** - 支付金币贿赂最近的敌人（每次100金币）
3. **满足条件** - 对同一个敌人至少贿赂2次 且 累计金额≥100金币
4. **成功！** - 敌人转换为友军，**自动跟随玩家**并为你战斗

💡 **提示**: 
- 这是俯视图游戏，不需要瞄准，只需要靠近敌人即可贿赂
- 被贿赂的友军会**自然跟随玩家**（围绕15米范围巡逻）
- 友军**保留完整AI**：会主动攻击、使用掩体、躲避伤害
- 友军移动自然流畅，像真正的队友一样战斗
- 友军会一直跟随直到死亡

### 调试按键
- **F9键** - 测试模式：显示金币ID信息
- **F8键** - 打印友军的所有组件列表（含子对象）
- **F7键** - 深度探索CharacterMainControl（字段、属性、方法、子对象）
- **F6键** - 探索AI控制器（查看巡逻点等AI参数）

## ⚙️ 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| bribePrice | 100 | 每次贿赂的价格（金币）|
| minBribeTimes | 2 | 最少贿赂次数 |
| minTotalAmount | 100 | 最少累计金额（金币）|
| bribeRange | 3.0 | 贿赂范围（米）|
| followUpdateInterval | 0.2 | 巡逻中心更新间隔（秒）- 每秒5次|
| debugMode | true | 调试模式（显示详细日志）|

## ✅ 已实现功能

- ✅ **距离检测敌人**（俯视图游戏适配）
- ✅ **自动选择最近敌人**
- ✅ **友军智能跟随**（修改AI巡逻中心点）⭐ 核心突破
- ✅ **保留完整AI**（攻击、掩体、躲避、战术）⭐ 关键优势
- ✅ **自然移动**（不倒退、不卡顿）
- ✅ **气泡消息提示**（头顶显示进度和结果）
- ✅ 贿赂次数统计
- ✅ 累计金额统计
- ✅ 双重条件判断（次数 + 金额）
- ✅ 敌人阵营转换
- ✅ 范围检测（Physics.OverlapSphere）
- ✅ 实时进度提示
- ✅ 友军列表管理
- ✅ 详细调试信息
- ✅ 强大的组件探索工具（F6/F7/F8）

## ⚠️ 待完善功能（需要探索游戏API）

- ⏳ 玩家金钱检测（当前：测试模式，总是允许）
- ⏳ 扣除玩家金钱（当前：仅日志输出）
- ✅ ~~确定正确的金币物品ID~~ → **已完成！ID = 451**

## 🎯 实现原理

### 核心API使用

```csharp
// 1. 距离检测（俯视图游戏）
Vector3 playerPos = player.transform.position;
Collider[] nearbyColliders = Physics.OverlapSphere(playerPos, bribeRange);

// 2. 筛选敌人
foreach (Collider col in nearbyColliders)
{
    CharacterMainControl character = col.GetComponent<CharacterMainControl>();
    if (character != null && !IsAlly(character))
    {
        nearbyEnemies.Add(character);
    }
}

// 3. 选择最近的敌人
float minDistance = float.MaxValue;
foreach (var enemy in nearbyEnemies)
{
    float distance = Vector3.Distance(playerPos, enemy.transform.position);
    if (distance < minDistance)
    {
        targetCharacter = enemy;
    }
}

// 4. 转换阵营（关键！）
enemy.SetTeam(玩家队伍);
```

### 数据结构

```csharp
// 贿赂记录类
private class BribeRecord
{
    public int Times = 0;         // 贿赂次数
    public int TotalAmount = 0;   // 累计金额
}

// 使用字典存储每个敌人的贿赂记录
Dictionary<CharacterMainControl, BribeRecord> bribeRecords;
```

## 🔄 工作流程

### 贿赂流程
```
1. 玩家按E键
   ↓
2. 找到玩家位置
   ↓
3. 距离检测（Physics.OverlapSphere）
   ├─ 搜索范围内所有碰撞体
   └─ 筛选出敌人角色
   ↓
4. 选择最近的敌人
   ↓
5. 检查金钱是否足够
   ↓
6. 扣除金钱 + 更新贿赂记录
   ├─ 次数 +1
   └─ 累计金额 +100
   ↓
7. 检查双重条件
   ├─ 次数 >= 2？
   └─ 金额 >= 100？
   ↓
8. 两个条件都满足？
   ├─ 是 → 转换为友军 + 添加到跟随列表 ✅
   └─ 否 → 显示还缺什么，等待继续贿赂
```

### 跟随流程（每0.2秒更新一次）- 巡逻中心策略
```
对每个友军：
   ↓
1. 获取玩家当前位置
   ↓
2. 修改友军的巡逻中心点为玩家位置
   ├─ 修改Movement组件的字段：
   │   ├─ homePosition = 玩家位置
   │   ├─ spawnPosition = 玩家位置
   │   └─ guardPosition = 玩家位置（如果有）
   └─ 修改CharacterMainControl的字段：
       ├─ spawnPos = 玩家位置
       └─ homePos = 玩家位置（如果有）
   
3. AI自动工作
   ├─ 友军会围绕新的巡逻中心（玩家）移动
   ├─ 保留所有原有AI行为（巡逻、战斗、躲避等）
   ├─ 移动自然流畅，不会倒着走
   └─ 自动攻击附近的敌人
```

**优势：**
- ✅ 不破坏原有AI系统
- ✅ 移动和战斗都由AI控制，自然流畅
- ✅ 友军会围绕玩家移动，不会回原地
- ✅ 无需强制控制朝向和移动
- ✅ 代码简单，性能更好

## 📝 下一步优化

### 需要探索的API
1. 查找玩家背包操作相关API
2. ✅ ~~确定金币的物品ID~~ → **已完成！ID = 451**
3. 实现从背包扣除金币物品
4. 实现检查背包中金币数量

### 可能的增强功能
- 🎨 添加贿赂成功的视觉效果
- 💬 显示贿赂进度提示
- 💰 根据敌人类型调整贿赂价格
- ⏰ 添加贿赂冷却时间
- 📊 显示贿赂成功率统计

## 🐛 已知问题

- 金钱系统为测试模式（不消耗真实金币）
- 需要确认玩家队伍的正确枚举值

## 📦 物品ID列表

详见 `物品ID列表.md`

**重要ID：**
- 💰 **金币**: 451
- 💎 **宝石**: 3
- 🔫 **Glick**: 254

## 🎓 学习价值

这个Mod演示了：
- ✅ Unity物理系统（OverlapSphere距离检测）
- ✅ 俯视图游戏的交互设计
- ✅ **AI行为控制（SetMoveInput持续跟随）**
- ✅ **Update循环中的定时器使用**
- ✅ 组件获取和操作（GetComponent/GetComponentInParent）
- ✅ 字典和列表数据结构使用
- ✅ 游戏阵营系统操作（SetTeam）
- ✅ 状态管理和计数
- ✅ 反射探索游戏API
- ✅ 多方法查找玩家对象
- ✅ 持续性任务管理（友军跟随列表）

